<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Cart - Android AIè‡ªåŠ¨åŒ–å·¥å…·</title>
    <!-- SheetJSåº“ï¼Œç”¨äºè§£æExcelæ–‡ä»¶ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        // API Configuration
        const API_CONFIG = {
            baseUrl: 'http://localhost:8000'
        };

        // åœºæ™¯é…ç½®
        const SCENARIOS = {
            SHOPPING: 'shopping',
            // é¢„ç•™å…¶ä»–åœºæ™¯
        };

        // å½“å‰é€‰æ‹©çš„åœºæ™¯
        let currentScenario = SCENARIOS.SHOPPING;

        // åœºæ™¯é…ç½®æ•°æ®
        const SCENARIO_CONFIGS = {
            [SCENARIOS.SHOPPING]: {
                name: 'è´­ç‰©åœºæ™¯',
                description: 'ç”¨äºç”µå•†è´­ç‰©ç›¸å…³ä»»åŠ¡',
                presetActions: {
                    search: 'æœç´¢å•†å“',
                    browse: 'æµè§ˆå•†å“è¯¦æƒ…',
                    addToCart: 'åŠ å…¥è´­ç‰©è½¦',
                    viewCart: 'æŸ¥çœ‹è´­ç‰©è½¦',
                    checkout: 'ç»“ç®—',
                },
                instructions: [
                    'è¯·ç¡®ä¿è®¾å¤‡å·²è¿æ¥ä¸”Portalåº”ç”¨å·²å®‰è£…',
                    'æ”¯æŒè‡ªç„¶è¯­è¨€æè¿°è´­ç‰©ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š',
                    '"æ‰“å¼€æ·˜å®ï¼Œæœç´¢iPhone 15ï¼ŒæŸ¥çœ‹ç¬¬ä¸€ä¸ªå•†å“"',
                    '"æ‰“å¼€äº¬ä¸œï¼Œæœç´¢ç¬”è®°æœ¬ç”µè„‘ï¼ŒåŠ å…¥è´­ç‰©è½¦"'
                ]
            }
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 0;
            line-height: 1.6;
            color: #343a40;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            background-color: #f8f9fa;
        }

        .sidebar {
            width: 280px;
            background-color: #ffffff;
            border-right: 1px solid #e9ecef;
            padding: 16px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
        }

        .container {
            max-width: 100%;
            height: 100%;
            background-color: #ffffff;
            border-radius: 0;
            padding: 0;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto auto auto auto 1fr;
            grid-gap: 1px;
            grid-template-areas:
                "header header"
                "scenario scenario"
                "task-input task-input"
                "input-box input-box"
                "history logs";
        }
        
        h1 {
            grid-area: header;
            text-align: center;
            color: #212529;
            margin-bottom: 1px;
            margin-left: 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        /* å†å²è®°å½•åŒºåŸŸ */
        .history {
            grid-area: history;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 300px;
            max-width: 300px;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 4px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .history::-webkit-scrollbar,
        .logs::-webkit-scrollbar {
            width: 4px;
        }
        
        .history::-webkit-scrollbar-track,
        .logs::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        
        .history::-webkit-scrollbar-thumb,
        .logs::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        .history::-webkit-scrollbar-thumb:hover,
        .logs::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .history-title {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .history-item {
            padding: 6px 10px;
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #495057;
            font-size: 12px;
        }
        
        .history-item:hover {
            background-color: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        /* æ—¥å¿—è¾“å‡ºåŒºåŸŸ */
        .logs {
            grid-area: logs;
            padding: 6px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            overflow-y: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 11px;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            height: 100%;
        }
        
        /* ä»»åŠ¡è¾“å…¥åŒºåŸŸ */
        .task-area {
            grid-area: task-input;
            padding: 2px;
        }
        
        /* è¾“å…¥å†…å®¹åŒºåŸŸ */
        .input-box {
            grid-area: input-box;
            padding: 4px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            text-align: left;
            color: #495057;
            font-size: 12px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
        }
        
        .input-box-title {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        /* æ“ä½œè¾“å…¥åŒºåŸŸ */
        .input-area {
            grid-area: task-input;
            padding: 8px;
        }
        
        .input-area label {
            display: block;
            margin-bottom: 1px;
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }
        
        .input-area textarea {
            width: 100%;
            height: 80px;
            padding: 3px;
            border: 1px solid #e9ecef;
            border-radius: 3px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: #868e96;
            box-shadow: 0 0 0 3px rgba(134, 142, 150, 0.1);
        }
        
        /* æ‰§è¡ŒæŒ‰é’®åŒºåŸŸ */
        .submit-btn {
            margin-top: 2px;
            display: flex;
            justify-content: flex-end;
        }
        
        button {
            padding: 7px 16px;
            background-color: #495057;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
            width: auto;
        }
        
        .task-mode-btn {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #343a40;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(73, 80, 87, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background-color: #ced4da;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #495057;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ç»“æœæ˜¾ç¤º */
        .result {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            transform: translateY(-10px);
            opacity: 0;
        }
        
        .result.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .success {
            background-color: #20c997;
        }
        
        .error {
            background-color: #dc3545;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                padding: 16px;
            }

            .main-content {
                padding: 16px;
            }

            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto;
                grid-template-areas:
                    "header"
                    "history"
                    "logs"
                    "input-area"
                    "submit-btn";
                padding: 16px;
            }

            .input-box {
                display: none;
            }

            .history {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 8px;
            }

            .history-item {
                flex: 0 0 auto;
                min-width: 120px;
            }

            .sidebar-section {
                margin-bottom: 16px;
            }

            .device-status {
                padding: 8px;
            }
        }
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar-header {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: #6c757d;
        }

        .sidebar-section {
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .device-status {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .device-status.connected {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
        }

        .device-status.disconnected {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .device-status-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .device-status.connected .device-status-icon {
            background-color: #17a2b8;
        }

        .device-status.disconnected .device-status-icon {
            background-color: #dc3545;
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .device-details {
            font-size: 12px;
            color: #6c757d;
        }

        .config-item {
            margin-bottom: 12px;
        }

        .config-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 3px;
        }

        .config-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        }

        .config-input:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .config-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 13px;
            color: #495057;
            background-color: #fff;
        }

        .sidebar-button {
            width: 100%;
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 6px;
        }

        .sidebar-button:hover {
            background-color: #0056b3;
        }

        .sidebar-button.secondary {
            background-color: #6c757d;
        }

        .sidebar-button.secondary:hover {
            background-color: #545b62;
        }

        .sidebar-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .task-mode-btn {
            transition: all 0.2s ease;
        }

        .task-mode-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .task-mode-btn.active {
            background-color: #007bff !important;
            border-color: #007bff !important;
            color: white !important;
        }

        /* ADBç»ˆç«¯æ ·å¼ */
        .adb-terminal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 70%;
            background-color: #000000;
            color: #ffffff;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #222222;
            border-bottom: 1px solid #444444;
            border-radius: 8px 8px 0 0;
        }

        .terminal-title {
            font-weight: bold;
            color: #cccccc;
        }

        .terminal-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .terminal-close:hover {
            background-color: #444444;
        }

        .terminal-body {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 16px;
        }

        .terminal-output {
            flex: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 12px;
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
        }

        .terminal-prompt {
            color: #00ff00;
            font-weight: bold;
            margin-right: 8px;
        }

        .terminal-input {
            flex: 1;
            background: none;
            border: none;
            color: #ffffff;
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            outline: none;
        }

        /* ç»ˆç«¯è¾“å‡ºæ ·å¼ */
        .terminal-output .command {
            color: #00ff00;
            font-weight: bold;
        }

        .terminal-output .success {
            color: #ffffff;
        }

        .terminal-output .error {
            color: #ff0000;
        }

        /* ç»ˆç«¯æ»šåŠ¨æ¡æ ·å¼ */
        .terminal-output::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: #222222;
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 4px;
        }

        .terminal-output::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Auto Cart</div>
                <div class="sidebar-subtitle">Android AIè‡ªåŠ¨åŒ–å·¥å…·</div>
            </div>

            <!-- è®¾å¤‡çŠ¶æ€ -->
            <div class="sidebar-section">
                <div class="section-title">è®¾å¤‡çŠ¶æ€</div>
                <div class="device-status disconnected" id="deviceStatus">
                    <div class="device-status-icon"></div>
                    <div class="device-info">
                        <div class="device-name" id="deviceName">æœªè¿æ¥</div>
                        <div class="device-details" id="deviceDetails">è¯·è¿æ¥Androidè®¾å¤‡</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="sidebar-button" id="connectDeviceBtn" style="flex: 1;">è¿æ¥è®¾å¤‡</button>
                    <button class="sidebar-button secondary" id="wifiConnectBtn" style="flex: 1;">WiFiè¿æ¥</button>
                </div>
                <button class="sidebar-button secondary" id="refreshDevicesBtn">åˆ·æ–°è®¾å¤‡åˆ—è¡¨</button>
                <div style="margin-top: 8px;">
                    <input type="file" id="portalApkFile" accept=".apk" style="font-size: 12px; width: 100%; margin-bottom: 8px;">
                    <button class="sidebar-button secondary" id="installPortalBtn" disabled>å®‰è£…Portal</button>
                </div>

                <!-- è®¾å¤‡åˆ—è¡¨ -->
                <div id="deviceList" style="display: none; margin-top: 12px;">
                    <div class="section-title" style="font-size: 12px; margin-bottom: 8px;">å¯ç”¨è®¾å¤‡</div>
                    <div id="deviceListContent"></div>
                </div>
            </div>

            <!-- LLMé…ç½® -->
            <div class="sidebar-section">
                <div class="section-title">AIé…ç½®</div>
                <div class="config-item">
                    <label class="config-label">æä¾›å•†</label>
                    <select class="config-select" id="llmProvider">
                        <option value="DeepSeek">DeepSeek</option>
                    </select>
                </div>
                <div class="config-item">
                    <label class="config-label">æ¨¡å‹</label>
                    <input type="text" class="config-input" id="llmModel" value="deepseek-chat">
                </div>
                <div class="config-item">
                    <label class="config-label">æ¸©åº¦</label>
                    <input type="number" class="config-input" id="llmTemperature" value="0.1" min="0" max="1" step="0.1">
                </div>
                <button class="sidebar-button" id="saveConfigBtn">ä¿å­˜é…ç½®</button>
            </div>

            <!-- é«˜çº§é€‰é¡¹ -->
            <div class="sidebar-section">
                <div class="section-title">é«˜çº§é€‰é¡¹</div>
                <div class="config-item">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enableVision" checked>
                        å¯ç”¨è§†è§‰åˆ†æ
                    </label>
                </div>
                <div class="config-item">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enableReasoning">
                        å¯ç”¨å¤æ‚æ¨ç†
                    </label>
                </div>
                <div class="config-item">
                    <label class="config-label">æœ€å¤§æ­¥éª¤æ•°</label>
                    <input type="number" class="config-input" id="maxSteps" value="20" min="1" max="50">
                </div>
            </div>

            <!-- å¼€å‘è€…é€‰é¡¹ -->
            <div class="sidebar-section">
                <div class="section-title">å¼€å‘è€…é€‰é¡¹</div>
                <button class="sidebar-button" id="takeScreenshotBtn">æˆªå–å±å¹•</button>
                <button class="sidebar-button" id="runAdbCommandBtn">æ‰§è¡ŒADBå‘½ä»¤</button>
                <button class="sidebar-button secondary" id="clearLogsBtn">æ¸…ç©ºæ—¥å¿—</button>
                <button class="sidebar-button secondary" id="exportLogsBtn">å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="container">
                <!-- æ ‡é¢˜åŒºåŸŸ -->
                <h1 style="grid-area: header; text-align: center; margin-bottom: 5px;">ä»»åŠ¡æ‰§è¡Œ</h1>
                <!-- ADBç»ˆç«¯ç•Œé¢ -->
                <div class="adb-terminal" id="adbTerminal" style="display: none;">
                    <div class="terminal-header">
                        <div class="terminal-title">ADBå‘½ä»¤ç»ˆç«¯</div>
                        <button class="terminal-close" id="closeTerminalBtn">Ã—</button>
                    </div>
                    <div class="terminal-body">
                        <div class="terminal-output" id="terminalOutput"></div>
                        <div class="terminal-input-line">
                            <span class="terminal-prompt">> </span>
                            <input type="text" class="terminal-input" id="terminalInput" autocomplete="off">
                        </div>
                    </div>
                </div>
                <!-- åœºæ™¯é€‰æ‹©åŒºåŸŸ -->
        <div class="scenario-section" style="grid-area: scenario; padding: 3px 6px; background-color: #f8f9fa; border-radius: 3px; margin: 0; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
            <h3 style="margin-bottom: 0; color: #495057; font-size: 11px; font-weight: 600; margin-top: 0;">åœºæ™¯é€‰æ‹©</h3>
            <select id="scenarioSelect" class="config-select" style="min-width: 120px; padding: 3px 6px; font-size: 11px; border: 1px solid #ced4da; border-radius: 3px; background-color: #fff; color: #495057; transition: all 0.2s ease;">
                <option value="shopping" selected>ğŸ›’ è´­ç‰©åœºæ™¯</option>
                <!-- é¢„ç•™å…¶ä»–åœºæ™¯ä½ç½® -->
            </select>
            <div style="color: #6c757d; font-size: 10px;">
                å½“å‰åœºæ™¯: <span id="currentScenarioText" style="color: #495057; font-weight: 500;">è´­ç‰©åœºæ™¯</span>
            </div>
            <div style="margin-left: auto;">
                <select id="taskModeSelect" style="padding: 3px 10px; border: 1px solid #007bff; background: white; color: #495057; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    <option value="single" selected>å•ä»»åŠ¡</option>
                    <option value="batch">æ‰¹é‡ä»»åŠ¡</option>
                </select>
            </div>
        </div>
        
        <!-- å†å²è®°å½•åŒºåŸŸ -->
        <div class="history">
            <div class="history-title">å†å²è®°å½•</div>
            <div class="history-item">æ‰“å¼€éŸ³ä¹</div>
            <div class="history-item">æ‰“å¼€å¾®ä¿¡</div>
            <div class="history-item">æ‰“å¼€æµè§ˆå™¨</div>
        </div>
        
        <!-- æ—¥å¿—è¾“å‡ºåŒºåŸŸ -->
        <div class="logs" id="logs">droidrunçš„æ—¥å¿—è¾“å‡º</div>
        
        <!-- è¾“å…¥å†…å®¹åŒºåŸŸ -->
        <div class="input-box" style="grid-area: input-box; margin-bottom: 4px;">
            <div class="input-box-title">å½“å‰æ“ä½œ</div>
            <div id="currentAction">è¾“å…¥çš„å†…å®¹</div>
        </div>
        
        <!-- å•ä»»åŠ¡è¾“å…¥åŒºåŸŸ -->
        <div id="singleTaskArea" class="task-area">
            <div class="input-area">
                <label for="action">è¯·è¾“å…¥éœ€è¦æ‰§è¡Œçš„æ“ä½œ:</label>
                <textarea id="action" placeholder="ä¾‹å¦‚: æ‰“å¼€æ·˜å®ï¼Œæœç´¢iPhone 15ï¼ŒæŸ¥çœ‹ç¬¬ä¸€ä¸ªå•†å“"></textarea>
                
                <!-- è´­ç‰©åœºæ™¯é¢„è®¾ä»»åŠ¡ -->
                <div id="shoppingPresets" class="presets-section" style="margin-top: 4px;">
                    <label style="font-size: 10px; color: #6c757d; margin-bottom: 2px; display: block;">è´­ç‰©åœºæ™¯é¢„è®¾ä»»åŠ¡:</label>
                    <div class="presets-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 4px; margin-bottom: 3px;">
                        <button class="preset-btn" data-action="æ‰“å¼€æ·˜å®ï¼Œæœç´¢iPhone 15ï¼ŒæŸ¥çœ‹ç¬¬ä¸€ä¸ªå•†å“" style="padding: 3px 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 3px; font-size: 10px; cursor: pointer; transition: all 0.2s; color: #495057;">æœç´¢å•†å“</button>
                        <button class="preset-btn" data-action="æ‰“å¼€äº¬ä¸œï¼Œæµè§ˆç¬”è®°æœ¬ç”µè„‘åˆ†ç±»ï¼ŒæŸ¥çœ‹çƒ­é—¨å•†å“" style="padding: 3px 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 3px; font-size: 10px; cursor: pointer; transition: all 0.2s; color: #495057;">æµè§ˆåˆ†ç±»</button>
                        <button class="preset-btn" data-action="æ‰“å¼€æ‹¼å¤šå¤šï¼Œæœç´¢è¿åŠ¨é‹ï¼ŒåŠ å…¥è´­ç‰©è½¦" style="padding: 3px 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 3px; font-size: 10px; cursor: pointer; transition: all 0.2s; color: #495057;">åŠ å…¥è´­ç‰©è½¦</button>
                        <button class="preset-btn" data-action="æ‰“å¼€æ·˜å®ï¼ŒæŸ¥çœ‹è´­ç‰©è½¦ï¼Œåˆ é™¤ç¬¬ä¸€ä¸ªå•†å“" style="padding: 3px 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 3px; font-size: 10px; cursor: pointer; transition: all 0.2s; color: #495057;">ç®¡ç†è´­ç‰©è½¦</button>
                    </div>
                </div>
                
                <div class="submit-btn">
                    <button id="submitBtn">æ‰§è¡Œæ“ä½œ</button>
                </div>
            </div>
        </div>

        <!-- æ‰¹é‡ä»»åŠ¡è¾“å…¥åŒºåŸŸ -->
        <div id="batchTaskArea" class="task-area" style="display: none;">
            <div class="input-area">
                <label for="batchActions">è¯·è¾“å…¥æ‰¹é‡æ“ä½œ (æ¯è¡Œä¸€ä¸ªæ“ä½œ):</label>
                <textarea id="batchActions" placeholder="æ‰“å¼€æ·˜å®&#10;æœç´¢iPhone&#10;æŸ¥çœ‹ç¬¬ä¸€ä¸ªå•†å“&#10;åŠ å…¥è´­ç‰©è½¦" rows="3"></textarea>
                <div style="margin-top: 8px;">
                    <label style="display: block; margin-bottom: 4px; color: #6c757d; font-size: 12px;">æˆ–å¯¼å…¥ä»»åŠ¡æ–‡ä»¶:</label>
                    <input type="file" id="batchFileImport" accept=".txt,.json,.xlsx,.xls" style="font-size: 12px; width: 100%;">
                    <div id="fileImportStatus" style="margin-top: 4px; font-size: 11px; color: #6c757d;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 8px; margin: 4px 0; padding: 0 4px;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 2px; color: #6c757d; font-size: 11px;">æ‰§è¡Œé—´éš” (ç§’)</label>
                    <input type="number" id="batchInterval" value="2" min="0" max="10" step="0.5" style="width: 100%; padding: 4px 5px; border: 1px solid #ced4da; border-radius: 3px; font-size: 11px;">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 2px; color: #6c757d; font-size: 11px;">å¤±è´¥æ—¶ç»§ç»­</label>
                    <input type="checkbox" id="continueOnError" checked style="margin-top: 2px; transform: scale(1);">
                </div>
            </div>

            <div class="submit-btn">
                <button id="submitBatchBtn">æ‰¹é‡æ‰§è¡Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    <div class="result" id="result"></div>
    
    <script>
        // ä¸»UIå…ƒç´ 
        const actionInput = document.getElementById('action');
        const submitBtn = document.getElementById('submitBtn');
        const resultDiv = document.getElementById('result');
        const logsDiv = document.getElementById('logs');
        const currentActionDiv = document.getElementById('currentAction');
        const historyDiv = document.querySelector('.history');
        const historyTitle = document.querySelector('.history-title');
        
        // åœºæ™¯é€‰æ‹©UIå…ƒç´ 
        const scenarioSelect = document.getElementById('scenarioSelect');
        const currentScenarioText = document.getElementById('currentScenarioText');

        // ä»»åŠ¡æ¨¡å¼åˆ‡æ¢
        const taskModeSelect = document.getElementById('taskModeSelect');
        const singleTaskArea = document.getElementById('singleTaskArea');
        const batchTaskArea = document.getElementById('batchTaskArea');
        const batchActionsInput = document.getElementById('batchActions');
        const batchIntervalInput = document.getElementById('batchInterval');
        const continueOnErrorInput = document.getElementById('continueOnError');
        const submitBatchBtn = document.getElementById('submitBatchBtn');
        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
        const batchFileImport = document.getElementById('batchFileImport');
        const fileImportStatus = document.getElementById('fileImportStatus');

        // åœºæ™¯é€‰æ‹©åˆå§‹åŒ–
        function initScenarioSelection() {
            // ç»‘å®šåœºæ™¯ä¸‹æ‹‰é€‰æ‹©äº‹ä»¶
            if (scenarioSelect) {
                scenarioSelect.addEventListener('change', (e) => {
                    selectScenario(e.target.value);
                });
            }
            
            // ç»‘å®šé¢„è®¾ä»»åŠ¡æŒ‰é’®äº‹ä»¶
            bindPresetButtons();
        }
        
        // ç»‘å®šé¢„è®¾ä»»åŠ¡æŒ‰é’®äº‹ä»¶
        function bindPresetButtons() {
            const presetBtns = document.querySelectorAll('.preset-btn');
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.getAttribute('data-action');
                    if (action) {
                        actionInput.value = action;
                        updateCurrentAction(action);
                    }
                });
            });
        }
        
        // é€‰æ‹©åœºæ™¯
        function selectScenario(scenarioId) {
            // æ›´æ–°å½“å‰åœºæ™¯
            currentScenario = scenarioId;
            
            // æ›´æ–°UIæ˜¾ç¤º
            if (scenarioSelect) {
                scenarioSelect.value = scenarioId;
            }
            
            if (currentScenarioText) {
                const scenarioConfig = SCENARIO_CONFIGS[scenarioId];
                if (scenarioConfig) {
                    currentScenarioText.textContent = scenarioConfig.name;
                }
            }
            
            // æ˜¾ç¤ºåœºæ™¯ç›¸å…³æç¤º
            updateScenarioInstructions();
        }
        
        // æ›´æ–°åœºæ™¯è¯´æ˜
        function updateScenarioInstructions() {
            const scenarioConfig = SCENARIO_CONFIGS[currentScenario];
            if (!scenarioConfig) return;
            
            console.log(`å½“å‰åœºæ™¯: ${scenarioConfig.name}`);
            console.log(`åœºæ™¯è¯´æ˜: ${scenarioConfig.description}`);
            console.log(`é¢„è®¾æ“ä½œ: ${JSON.stringify(scenarioConfig.presetActions)}`);
        }

        // ä¾§è¾¹æ å…ƒç´ 
        const deviceStatus = document.getElementById('deviceStatus');
        const deviceName = document.getElementById('deviceName');
        const deviceDetails = document.getElementById('deviceDetails');
        const connectDeviceBtn = document.getElementById('connectDeviceBtn');
        const wifiConnectBtn = document.getElementById('wifiConnectBtn');
        const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
        const installPortalBtn = document.getElementById('installPortalBtn');
        const deviceList = document.getElementById('deviceList');
        const deviceListContent = document.getElementById('deviceListContent');
        const llmProvider = document.getElementById('llmProvider');
        const llmModel = document.getElementById('llmModel');
        const llmTemperature = document.getElementById('llmTemperature');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const enableVision = document.getElementById('enableVision');
        const enableReasoning = document.getElementById('enableReasoning');
        const maxSteps = document.getElementById('maxSteps');

        // å¼€å‘è€…é€‰é¡¹å…ƒç´ 
        const takeScreenshotBtn = document.getElementById('takeScreenshotBtn');
        const runAdbCommandBtn = document.getElementById('runAdbCommandBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const exportLogsBtn = document.getElementById('exportLogsBtn');

        // åº”ç”¨é…ç½®
        let appConfig = {
            llmProvider: 'DeepSeek',
            llmModel: 'deepseek-chat',
            llmTemperature: 0.1,
            enableVision: true,
            enableReasoning: false,
            maxSteps: 20
        };

        // ä»»åŠ¡æ¨¡å¼åˆ‡æ¢
        let currentTaskMode = 'single';

        taskModeSelect.addEventListener('change', () => {
            currentTaskMode = taskModeSelect.value;
            if (currentTaskMode === 'single') {
                singleTaskArea.style.display = 'block';
                batchTaskArea.style.display = 'none';
            } else {
                singleTaskArea.style.display = 'none';
                batchTaskArea.style.display = 'block';
            }
        });

        // è¯»å–æ–‡ä»¶å†…å®¹çš„å‡½æ•°
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        // è§£æExcelæ–‡ä»¶
        async function parseExcelFile(content) {
            // ä½¿ç”¨SheetJSè§£æExcelæ–‡ä»¶
            const workbook = XLSX.read(content, { type: 'array' });
            // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSONæ•°æ®
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // æå–ç¬¬ä¸€åˆ—ä½œä¸ºä»»åŠ¡åˆ—è¡¨ï¼ˆå¿½ç•¥ç©ºè¡Œï¼‰
            const tasks = [];
            for (const row of jsonData) {
                if (row && row[0] && row[0].toString().trim()) {
                    tasks.push(row[0].toString().trim());
                }
            }
            
            return tasks;
        }

        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶å¤„ç†
        batchFileImport.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const statusElement = fileImportStatus;
            statusElement.textContent = 'æ­£åœ¨è§£ææ–‡ä»¶...';
            statusElement.style.color = '#6c757d';
            
            try {
                const content = await readFile(file);
                let tasks = [];
                
                if (file.name.endsWith('.txt')) {
                    // è§£æTXTæ–‡ä»¶ï¼ˆæŒ‰è¡Œæ‹†åˆ†ï¼‰
                    const textContent = new TextDecoder().decode(content);
                    tasks = textContent.split('\n').filter(line => line.trim());
                } else if (file.name.endsWith('.json')) {
                    // è§£æJSONæ–‡ä»¶
                    const textContent = new TextDecoder().decode(content);
                    const jsonData = JSON.parse(textContent);
                    tasks = Array.isArray(jsonData) ? jsonData : (jsonData.tasks || []);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // è§£æExcelæ–‡ä»¶
                    tasks = await parseExcelFile(content);
                } else {
                    throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                }
                
                if (tasks.length === 0) {
                    throw new Error('æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä»»åŠ¡');
                }
                
                // å°†ä»»åŠ¡å¡«å……åˆ°æ–‡æœ¬æ¡†
                batchActionsInput.value = tasks.join('\n');
                
                statusElement.textContent = `æˆåŠŸå¯¼å…¥ ${tasks.length} ä¸ªä»»åŠ¡`;
                statusElement.style.color = '#20c997';
                
            } catch (error) {
                statusElement.textContent = `è§£æå¤±è´¥: ${error.message}`;
                statusElement.style.color = '#dc3545';
            }
        });
        
        // è·å–å†å²è®°å½•
        async function fetchHistory() {
            try {
                const response = await fetch(API_CONFIG.baseUrl + '/history');
                if (!response.ok) {
                    throw new Error('Failed to fetch history');
                }
                const history = await response.json();
                renderHistory(history);
            } catch (error) {
                console.error('Error fetching history:', error);
            }
        }
        
        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory(history) {
            // æ¸…ç©ºç°æœ‰å†å²è®°å½•ï¼ˆä¿ç•™æ ‡é¢˜ï¼‰
            while (historyDiv.children.length > 1) {
                historyDiv.removeChild(historyDiv.lastChild);
            }
            
            if (history.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'history-item';
                emptyItem.textContent = 'æš‚æ— å†å²è®°å½•';
                emptyItem.style.color = '#999';
                emptyItem.style.cursor = 'default';
                emptyItem.style.background = '#f0f0f0';
                historyDiv.appendChild(emptyItem);
                return;
            }
            
            // åˆ›å»ºæ–°çš„å†å²è®°å½•é¡¹
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.textContent = item.action;
                historyItem.title = `${item.success ? 'æˆåŠŸ' : 'å¤±è´¥'}: ${item.reason}\næ—¶é—´: ${new Date(item.timestamp).toLocaleString()}`;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                historyItem.addEventListener('click', () => {
                    actionInput.value = item.action;
                    updateCurrentAction(item.action);
                });
                
                historyDiv.appendChild(historyItem);
            });
        }
        
        // æ‰§è¡ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        submitBtn.addEventListener('click', async () => {
            const action = actionInput.value.trim();
            
            if (!action) {
                showResult('è¯·è¾“å…¥éœ€è¦æ‰§è¡Œçš„æ“ä½œ', 'error');
                return;
            }
            
            // æ›´æ–°å½“å‰æ“ä½œæ˜¾ç¤º
            updateCurrentAction(action);
            
            showLoading();
            
            // æ¸…ç©ºä¹‹å‰çš„æ—¥å¿—
            logsDiv.innerHTML = '';
            
            try {
                // å‡†å¤‡è¯·æ±‚æ•°æ®ï¼ŒåŒ…å«å½“å‰åœºæ™¯ä¿¡æ¯
                const requestData = {
                    action,
                    scenario: currentScenario,
                };
                
                // é¦–å…ˆå‘é€ POST è¯·æ±‚æ¥å¯åŠ¨æ‰§è¡Œ
                const response = await fetch(API_CONFIG.baseUrl + '/stream-execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });
                
                // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                // è·å–å“åº”çš„å¯è¯»æµ
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                let resultJson = '';
                
                // å¾ªç¯è¯»å–æµä¸­çš„æ•°æ®
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    // è§£ç äºŒè¿›åˆ¶æ•°æ®ä¸ºæ–‡æœ¬
                    const chunk = decoder.decode(value, { stream: true });
                    
                    // åˆ†å‰² SSE æ ¼å¼çš„æ¶ˆæ¯
                    const messages = chunk.split('\n\n');
                    
                    for (const message of messages) {
                        if (message.startsWith('data:')) {
                            const jsonStr = message.slice(5).trim();
                            if (jsonStr) {
                                try {
                                    const data = JSON.parse(jsonStr);
                                    if (data.log) {
                                        // è¿½åŠ æ—¥å¿—å†…å®¹
                                        logsDiv.innerHTML += data.log;
                                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                        logsDiv.scrollTop = logsDiv.scrollHeight;
                                    }
                                } catch (e) {
                                    console.error('Error parsing log data:', e);
                                }
                            }
                        }
                    }
                }
                
                // æ‰§è¡Œå®Œæˆåæ›´æ–°å†å²è®°å½•
                fetchHistory();
                showResult('æ“ä½œæ‰§è¡Œå®Œæˆï¼', 'success');
                
            } catch (error) {
                showResult(`è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');
                logsDiv.innerHTML = 'æ— æ—¥å¿—ä¿¡æ¯';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'æ‰§è¡Œæ“ä½œ';
            }
        });
        
        // æ›´æ–°å½“å‰æ“ä½œæ˜¾ç¤º
        function updateCurrentAction(action) {
            currentActionDiv.textContent = action;
        }
        
        function showLoading() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div>æ‰§è¡Œä¸­...';
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            hideResult();
        }
        
        function showResult(message, type) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'æ‰§è¡Œæ“ä½œ';
            
            // æ˜¾ç¤ºç»“æœé€šçŸ¥
            resultDiv.className = `result ${type} show`;
            resultDiv.innerHTML = message;
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                hideResult();
            }, 3000);
        }
        
        function hideResult() {
            resultDiv.classList.remove('show');
        }
        
        function showLogs(stdout, stderr) {
            let logsContent = '';
            
            if (stdout) {
                logsContent += stdout;
            }
            
            if (stderr) {
                if (logsContent) {
                    logsContent += '\n\n';
                }
                logsContent += stderr;
            }
            
            if (!logsContent) {
                logsContent = 'æ— æ—¥å¿—ä¿¡æ¯';
            }
            
            logsDiv.innerHTML = logsContent;
        }
        
        // è®¾å¤‡ç®¡ç†åŠŸèƒ½
        async function checkDeviceStatus() {
            try {
                const response = await fetch(API_CONFIG.baseUrl + '/device/status');
                if (response.ok) {
                    const status = await response.json();
                    updateDeviceStatus(status);
                }
            } catch (error) {
                console.error('Failed to check device status:', error);
                updateDeviceStatus({ connected: false });
            }
        }

        function updateDeviceStatus(status) {
            if (status.connected) {
                deviceStatus.className = 'device-status connected';
                deviceName.textContent = status.name || 'Androidè®¾å¤‡';
                deviceDetails.textContent = `Android ${status.version || ''} | ${status.model || ''}`;
                connectDeviceBtn.textContent = 'æ–­å¼€è¿æ¥';

                if (status.portal_installed) {
                    installPortalBtn.textContent = 'Portalå·²å®‰è£…';
                    installPortalBtn.disabled = true;
                } else {
                    installPortalBtn.textContent = 'å®‰è£…Portal';
                    installPortalBtn.disabled = false;
                }
            } else {
                deviceStatus.className = 'device-status disconnected';
                deviceName.textContent = 'æœªè¿æ¥';
                deviceDetails.textContent = 'è¯·è¿æ¥Androidè®¾å¤‡';
                connectDeviceBtn.textContent = 'è¿æ¥è®¾å¤‡';
                installPortalBtn.textContent = 'å®‰è£…Portal';
                installPortalBtn.disabled = true;
            }
        }

        // USBè¿æ¥è®¾å¤‡
        connectDeviceBtn.addEventListener('click', async () => {
            const isConnected = deviceStatus.classList.contains('connected');

            if (isConnected) {
                // æ–­å¼€è¿æ¥
                try {
                    await fetch(API_CONFIG.baseUrl + '/device/disconnect', { method: 'POST' });
                    showResult('è®¾å¤‡å·²æ–­å¼€è¿æ¥', 'success');
                } catch (error) {
                    showResult('æ–­å¼€è¿æ¥å¤±è´¥', 'error');
                }
            } else {
                // USBè¿æ¥è®¾å¤‡
                await connectDevice('usb');
            }

            setTimeout(checkDeviceStatus, 2000);
        });

        // WiFiè¿æ¥è®¾å¤‡
        wifiConnectBtn.addEventListener('click', async () => {
            const ipAddress = prompt('è¯·è¾“å…¥è®¾å¤‡IPåœ°å€ (ä¾‹å¦‚: 192.168.1.100):');
            if (ipAddress && ipAddress.trim()) {
                await connectDevice('wifi', ipAddress.trim());
                setTimeout(checkDeviceStatus, 3000);
            }
        });

        // é€šç”¨è¿æ¥å‡½æ•°
        async function connectDevice(type, ipAddress = null) {
            try {
                showResult(`æ­£åœ¨${type === 'usb' ? 'USB' : 'WiFi'}è¿æ¥è®¾å¤‡...`, 'success');

                const requestData = { type: type };
                if (ipAddress) {
                    requestData.ip_address = ipAddress;
                }

                const response = await fetch(API_CONFIG.baseUrl + '/device/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`${type === 'usb' ? 'USB' : 'WiFi'}è¿æ¥æˆåŠŸ: ${result.message}`, 'success');

                    // æ›´æ–°è®¾å¤‡çŠ¶æ€
                    if (result.device) {
                        updateDeviceStatus(result.device);
                    }
                } else {
                    const error = await response.json();
                    showResult(`${type === 'usb' ? 'USB' : 'WiFi'}è¿æ¥å¤±è´¥: ${error.detail}`, 'error');
                }
            } catch (error) {
                showResult(`${type === 'usb' ? 'USB' : 'WiFi'}è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å®‰è£…Portalåº”ç”¨
        installPortalBtn.addEventListener('click', async () => {
            try {
                installPortalBtn.disabled = true;
                installPortalBtn.textContent = 'å®‰è£…ä¸­...';

                const portalApkFile = document.getElementById('portalApkFile');
                let response;

                if (portalApkFile && portalApkFile.files && portalApkFile.files.length > 0) {
                    // å¦‚æœç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶ï¼Œä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ–¹å¼
                    const file = portalApkFile.files[0];
                    const formData = new FormData();
                    formData.append('file', file);

                    response = await fetch(API_CONFIG.baseUrl + '/device/install-portal', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // å¦åˆ™å°è¯•ä»ç½‘ç»œä¸‹è½½
                    response = await fetch(API_CONFIG.baseUrl + '/device/install-portal', {
                        method: 'POST'
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    showResult(result.message, 'success');
                    // æ›´æ–°è®¾å¤‡çŠ¶æ€
                    setTimeout(checkDeviceStatus, 1000);
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    if (portalApkFile) {
                        portalApkFile.value = '';
                    }
                } else {
                    // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.detail || 'å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                    showResult(`Portalåº”ç”¨å®‰è£…å¤±è´¥: ${errorMessage}`, 'error');
                }
            } catch (error) {
                showResult('å®‰è£…å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                installPortalBtn.disabled = false;
                installPortalBtn.textContent = 'å®‰è£…Portal';
            }
        });

        // ä¿å­˜é…ç½®
        saveConfigBtn.addEventListener('click', () => {
            appConfig = {
                llmProvider: llmProvider.value,
                llmModel: llmModel.value,
                llmTemperature: parseFloat(llmTemperature.value),
                enableVision: enableVision.checked,
                enableReasoning: enableReasoning.checked,
                maxSteps: parseInt(maxSteps.value)
            };

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('droidrun-config', JSON.stringify(appConfig));

            showResult('é…ç½®å·²ä¿å­˜', 'success');

            // å‘é€é…ç½®åˆ°åç«¯
            fetch(API_CONFIG.baseUrl + '/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(appConfig)
            }).catch(error => console.error('Failed to save config to backend:', error));
        });

        // åŠ è½½é…ç½®
        function loadConfig() {
            const saved = localStorage.getItem('droidrun-config');
            if (saved) {
                appConfig = { ...appConfig, ...JSON.parse(saved) };
            }

            // æ›´æ–°UI
            llmProvider.value = appConfig.llmProvider;
            llmModel.value = appConfig.llmModel;
            llmTemperature.value = appConfig.llmTemperature;
            enableVision.checked = appConfig.enableVision;
            enableReasoning.checked = appConfig.enableReasoning;
            maxSteps.value = appConfig.maxSteps;
        }

        // åˆå§‹åŒ–
        updateCurrentAction(actionInput.value.trim());
        fetchHistory();
        loadConfig();
        checkDeviceStatus();
        initScenarioSelection();

        // å¼€å‘è€…åŠŸèƒ½
        takeScreenshotBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(API_CONFIG.baseUrl + '/device/screenshot');
                if (response.ok) {
                    const result = await response.json();
                    showResult('å±å¹•æˆªå›¾å·²ä¿å­˜', 'success');
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ˜¾ç¤ºæˆªå›¾çš„é€»è¾‘
                } else {
                    showResult('æˆªå›¾å¤±è´¥', 'error');
                }
            } catch (error) {
                showResult('æˆªå›¾å¤±è´¥ï¼š' + error.message, 'error');
            }
        });

        // ADBç»ˆç«¯å…ƒç´ 
        const adbTerminal = document.getElementById('adbTerminal');
        const terminalOutput = document.getElementById('terminalOutput');
        const terminalInput = document.getElementById('terminalInput');
        const closeTerminalBtn = document.getElementById('closeTerminalBtn');

        // æ˜¾ç¤ºç»ˆç«¯ç•Œé¢
        runAdbCommandBtn.addEventListener('click', () => {
            adbTerminal.style.display = 'flex';
            terminalInput.focus();
            // æ¸…ç©ºä¹‹å‰çš„è¾“å‡º
            terminalOutput.innerHTML = 'ADBå‘½ä»¤ç»ˆç«¯å·²å¯åŠ¨\nè¾“å…¥ADBå‘½ä»¤å¹¶æŒ‰Enteré”®æ‰§è¡Œ\n\n';
        });

        // å…³é—­ç»ˆç«¯ç•Œé¢
        closeTerminalBtn.addEventListener('click', () => {
            adbTerminal.style.display = 'none';
        });

        // ç»ˆç«¯è¾“å…¥å¤„ç†
        terminalInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const command = terminalInput.value.trim();
                if (command) {
                    // æ˜¾ç¤ºè¾“å…¥çš„å‘½ä»¤
                    terminalOutput.innerHTML += `<span class="command">> ${command}</span>\n`;
                    terminalInput.value = '';
                    
                    // æ‰§è¡Œå‘½ä»¤
                    await executeAdbCommand(command);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                }
            }
        });

        async function executeAdbCommand(command) {
            try {
                const response = await fetch(API_CONFIG.baseUrl + '/device/adb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command })
                });

                if (response.ok) {
                    const result = await response.json();
                    terminalOutput.innerHTML += `<span class="success">${result.stdout || result.message}</span>\n`;
                    if (result.stderr) {
                        terminalOutput.innerHTML += `<span class="error">${result.stderr}</span>\n`;
                    }
                } else {
                    const error = await response.json();
                    terminalOutput.innerHTML += `<span class="error">é”™è¯¯: ${error.detail}</span>\n`;
                }
            } catch (error) {
                terminalOutput.innerHTML += `<span class="error">å¼‚å¸¸: ${error.message}</span>\n`;
            }
        }

        clearLogsBtn.addEventListener('click', () => {
            logsDiv.innerHTML = '';
            showResult('æ—¥å¿—å·²æ¸…ç©º', 'success');
        });

        exportLogsBtn.addEventListener('click', () => {
            const logs = logsDiv.innerText;
            if (!logs.trim()) {
                showResult('æ²¡æœ‰æ—¥å¿—å¯å¯¼å‡º', 'error');
                return;
            }

            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `droidrun-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showResult('æ—¥å¿—å·²å¯¼å‡º', 'success');
        });

        // æ‰¹é‡æ‰§è¡ŒåŠŸèƒ½
        submitBatchBtn.addEventListener('click', async () => {
            const actions = batchActionsInput.value.trim().split('\n').filter(action => action.trim());
            if (actions.length === 0) {
                showResult('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ“ä½œ', 'error');
                return;
            }

            const interval = parseFloat(batchIntervalInput.value) * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
            const continueOnError = continueOnErrorInput.checked;

            submitBatchBtn.disabled = true;
            submitBatchBtn.textContent = 'æ‰¹é‡æ‰§è¡Œä¸­...';

            try {
                for (let i = 0; i < actions.length; i++) {
                    const action = actions[i].trim();
                    if (!action) continue;

                    showResult(`æ‰§è¡Œä»»åŠ¡ ${i + 1}/${actions.length}: ${action}`, 'success');
                    currentActionDiv.textContent = action;

                    try {
                        await executeSingleAction(action);

                        // ç­‰å¾…é—´éš”ï¼ˆé™¤äº†æœ€åä¸€ä¸ªä»»åŠ¡ï¼‰
                        if (i < actions.length - 1 && interval > 0) {
                            await new Promise(resolve => setTimeout(resolve, interval));
                        }
                    } catch (error) {
                        showResult(`ä»»åŠ¡ ${i + 1} å¤±è´¥: ${error.message}`, 'error');
                        if (!continueOnError) {
                            break;
                        }
                    }
                }

                showResult('æ‰¹é‡æ‰§è¡Œå®Œæˆ', 'success');
            } catch (error) {
                showResult('æ‰¹é‡æ‰§è¡Œå¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                submitBatchBtn.disabled = false;
                submitBatchBtn.textContent = 'æ‰¹é‡æ‰§è¡Œ';
            }
        });

        // è¾…åŠ©å‡½æ•°ï¼šæ‰§è¡Œå•ä¸ªæ“ä½œï¼ˆå¤ç”¨å•ä»»åŠ¡é€»è¾‘ï¼‰
        async function executeSingleAction(action) {
            showLoading();

            try {
                // å‡†å¤‡è¯·æ±‚æ•°æ®ï¼ŒåŒ…å«å½“å‰åœºæ™¯ä¿¡æ¯
                const requestData = {
                    action,
                    scenario: currentScenario,
                };
                
                const response = await fetch(API_CONFIG.baseUrl + '/stream-execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const messages = chunk.split('\n\n');

                    for (const message of messages) {
                        if (message.startsWith('data:')) {
                            const jsonStr = message.slice(5).trim();
                            if (jsonStr) {
                                try {
                                    const data = JSON.parse(jsonStr);
                                    if (data.log) {
                                        logsDiv.innerHTML += data.log;
                                        logsDiv.scrollTop = logsDiv.scrollHeight;
                                    }
                                } catch (e) {
                                    console.error('Error parsing log data:', e);
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                throw error;
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'æ‰§è¡Œæ“ä½œ';
                hideResult();
            }
        }

        // æ›´æ–°CSSæ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .task-mode-btn.active {
                background-color: #007bff !important;
                color: white !important;
                border-color: #007bff !important;
            }
            .task-area {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ADBç»ˆç«¯æ ·å¼ */
        .adb-terminal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 70%;
            background-color: #000000;
            color: #ffffff;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }
        
        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #2d2d2d;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-bottom: 1px solid #444;
        }
        
        .terminal-title {
            font-weight: 500;
            color: #cccccc;
        }
        
        .terminal-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .terminal-close:hover {
            background-color: #444444;
        }
        
        .terminal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow: hidden;
        }
        
        .terminal-output {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 10px;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        
        .terminal-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .terminal-output::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .terminal-output::-webkit-scrollbar-thumb {
            background: #444444;
            border-radius: 4px;
        }
        
        .terminal-output::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
        
        .terminal-input-line {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        
        .terminal-prompt {
            color: #00ff00;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .terminal-input {
            flex: 1;
            background: none;
            border: none;
            color: #ffffff;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            padding: 0;
        }
        
        .terminal-input:focus {
            outline: none;
        }
        
        /* å‘½ä»¤è¾“å‡ºé¢œè‰² */
        .terminal-output .command {
            color: #00ff00;
        }
        
        .terminal-output .success {
            color: #ffffff;
        }
        
        .terminal-output .error {
            color: #ff0000;
        }
    `;
        document.head.appendChild(style);

        // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
        refreshDevicesBtn.addEventListener('click', async () => {
            await refreshDeviceList();
        });

        // åˆ·æ–°è®¾å¤‡åˆ—è¡¨å‡½æ•°
        async function refreshDeviceList() {
            try {
                const response = await fetch(API_CONFIG.baseUrl + '/devices');
                if (response.ok) {
                    const data = await response.json();
                    displayDeviceList(data.devices);
                    deviceList.style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to refresh device list:', error);
                deviceList.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
        function displayDeviceList(devices) {
            if (devices.length === 0) {
                deviceListContent.innerHTML = '<div style="color: #6c757d; font-size: 12px; padding: 8px;">æœªå‘ç°è®¾å¤‡</div>';
                return;
            }

            deviceListContent.innerHTML = devices.map(device => {
                let statusColor = '#dc3545'; // red for disconnected
                let statusText = 'æœªè¿æ¥';
                let actionButton = '';

                if (device.status === 'device') {
                    statusColor = '#28a745'; // green for connected
                    statusText = 'å·²è¿æ¥';
                    if (device.portal_installed) {
                        statusText += ' â€¢ Portalå·²å®‰è£…';
                    } else {
                        actionButton = `<button class="device-connect-btn" onclick="installPortalOnDevice('${device.id}')" style="margin-top: 6px; padding: 4px 8px; font-size: 11px; background: #ffc107; color: #212529; border: none; border-radius: 3px; cursor: pointer;">å®‰è£…Portal</button>`;
                    }
                } else if (device.status === 'unauthorized') {
                    statusColor = '#ffc107'; // yellow for unauthorized
                    statusText = 'æœªæˆæƒ - è¯·åœ¨è®¾å¤‡ä¸Šå…è®¸USBè°ƒè¯•';
                    actionButton = `<button class="device-connect-btn" onclick="connectSpecificDevice('${device.id}')" style="margin-top: 6px; padding: 4px 8px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">é‡è¯•è¿æ¥</button>`;
                } else if (device.status === 'offline') {
                    statusColor = '#6c757d'; // gray for offline
                    statusText = 'ç¦»çº¿';
                    actionButton = `<button class="device-connect-btn" onclick="connectSpecificDevice('${device.id}')" style="margin-top: 6px; padding: 4px 8px; font-size: 11px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">é‡è¯•è¿æ¥</button>`;
                } else {
                    actionButton = `<button class="device-connect-btn" onclick="connectSpecificDevice('${device.id}')" style="margin-top: 6px; padding: 4px 8px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">è¿æ¥</button>`;
                }

                return `
                    <div class="device-item" style="padding: 8px; border: 1px solid #e9ecef; border-radius: 4px; margin-bottom: 8px; background: #f8f9fa;">
                        <div style="font-size: 12px; font-weight: 500; margin-bottom: 4px;">${device.name || device.id}</div>
                        <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">
                            ${device.model || 'Unknown'} â€¢ Android ${device.version || 'Unknown'}
                        </div>
                        <div style="font-size: 11px; color: ${statusColor}; margin-bottom: 4px;">
                            ${statusText}
                        </div>
                        ${actionButton}
                    </div>
                `;
            }).join('');
        }

        // è¿æ¥ç‰¹å®šè®¾å¤‡
        async function connectSpecificDevice(deviceId) {
            try {
                showResult('æ­£åœ¨è¿æ¥è®¾å¤‡...', 'success');

                const response = await fetch(API_CONFIG.baseUrl + '/device/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ type: 'usb', device_id: deviceId })
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`è®¾å¤‡è¿æ¥æˆåŠŸ: ${result.message}`, 'success');

                    // åˆ·æ–°çŠ¶æ€
                    setTimeout(() => {
                        checkDeviceStatus();
                        refreshDeviceList();
                    }, 2000);
                } else {
                    const error = await response.json();
                    showResult(`è®¾å¤‡è¿æ¥å¤±è´¥: ${error.detail}`, 'error');
                }
            } catch (error) {
                showResult('è®¾å¤‡è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åœ¨ç‰¹å®šè®¾å¤‡ä¸Šå®‰è£…Portal
        async function installPortalOnDevice(deviceId) {
            try {
                showResult('æ­£åœ¨å®‰è£…Portalåº”ç”¨...', 'success');

                const response = await fetch(API_CONFIG.baseUrl + '/device/install-portal', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`Portalå®‰è£…æˆåŠŸ: ${result.message}`, 'success');

                    // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                    setTimeout(refreshDeviceList, 2000);
                } else {
                    const error = await response.json();
                    showResult(`Portalå®‰è£…å¤±è´¥: ${error.detail}`, 'error');
                }
            } catch (error) {
                showResult('Portalå®‰è£…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡è®¾å¤‡åˆ—è¡¨
        setTimeout(refreshDeviceList, 1000);

        // å®šæœŸæ£€æŸ¥è®¾å¤‡çŠ¶æ€
        setInterval(checkDeviceStatus, 5000);
    </script>
</body>
</html>